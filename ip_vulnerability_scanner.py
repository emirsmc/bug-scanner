import socket, asyncio, aiohttp, concurrent.futures, json
from datetime import datetime

THREADS = 500
PORT_RANGE = range(1, 65536)

# -------------------------------
# CVSS-like Severity Scoring
# -------------------------------
SEVERITY_SCORES = {
    "Critical": 9.0,
    "High": 7.0,
    "Medium": 5.0,
    "Low": 3.0,
    "Info": 1.0
}

# -------------------------------
# Port Scanner
# -------------------------------
def scan_port(ip, port):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(0.3)
        result = sock.connect_ex((ip, port))
        sock.close()
        if result == 0:
            return port
    except:
        return None

def fast_port_scan(ip):
    open_ports = []
    with concurrent.futures.ThreadPoolExecutor(max_workers=THREADS) as executor:
        futures = [executor.submit(scan_port, ip, port) for port in PORT_RANGE]
        for f in concurrent.futures.as_completed(futures):
            port = f.result()
            if port:
                open_ports.append(port)
    return open_ports

# -------------------------------
# Vulnerability Checks (Plugins inline)
# -------------------------------
async def check_sql_injection(session, url):
    payload = "' OR '1'='1"
    try:
        async with session.get(url, params={"id": payload}) as r:
            text = await r.text()
            if "syntax" in text.lower() or "error" in text.lower():
                return {
                    "vuln": "SQL Injection",
                    "severity": "High",
                    "score": SEVERITY_SCORES["High"],
                    "reference": "OWASP A1",
                    "payload": payload,
                    "response_snippet": text[:200]
                }
            if any(keyword in text for keyword in ["Fastly", "Cloudflare", "Varnish"]):
                return {
                    "vuln": "CDN Error Page (Not exploitable)",
                    "severity": "Info",
                    "score": SEVERITY_SCORES["Info"],
                    "reference": "OWASP Context",
                    "payload": payload,
                    "response_snippet": text[:200]
                }
    except:
        pass
    return None

async def check_xss(session, url):
    payload = "<script>alert(1)</script>"
    try:
        async with session.get(url, params={"q": payload}) as r:
            text = await r.text()
            if payload in text:
                return {
                    "vuln": "Cross-Site Scripting (XSS)",
                    "severity": "High",
                    "score": SEVERITY_SCORES["High"],
                    "reference": "OWASP A3",
                    "payload": payload,
                    "response_snippet": text[:200]
                }
    except:
        pass
    return None

async def check_headers(session, url):
    try:
        async with session.get(url) as r:
            headers = r.headers
            missing = []
            if "Content-Security-Policy" not in headers:
                missing.append("CSP")
            if "Strict-Transport-Security" not in headers:
                missing.append("HSTS")
            if missing:
                return {
                    "vuln": f"Insecure Headers: {', '.join(missing)}",
                    "severity": "Medium",
                    "score": SEVERITY_SCORES["Medium"],
                    "reference": "OWASP A6",
                    "payload": None,
                    "response_snippet": str(dict(headers))[:200]
                }
    except:
        pass
    return None

# -------------------------------
# Run All Checks
# -------------------------------
async def run_checks(ip, ports):
    vulns = []
    async with aiohttp.ClientSession() as session:
        tasks = []
        for port in ports:
            if port in [80, 443]:
                url = f"http://{ip}" if port == 80 else f"https://{ip}"
                tasks.extend([
                    check_sql_injection(session, url),
                    check_xss(session, url),
                    check_headers(session, url)
                ])
        results = await asyncio.gather(*tasks)
        for r in results:
            if r:
                vulns.append(r)
                # Save full response for context
                with open("responses.log", "a") as log:
                    log.write(json.dumps(r, indent=4) + "\n")
    return vulns

# -------------------------------
# Reporting
# -------------------------------
def generate_report(ip, ports, vulns):
    report = {
        "target": ip,
        "scan_time": datetime.now().isoformat(),
        "open_ports": ports,
        "vulnerabilities": vulns
    }
    print("\n================= SCAN REPORT =================")
    print(json.dumps(report, indent=4))
    return report

# -------------------------------
# Main
# -------------------------------
if __name__ == "__main__":
    target_ip = input("Enter target IP address: ")
    print(f"[*] Starting ultra-fast port scan on {target_ip}")
    ports = fast_port_scan(target_ip)
    print(f"[+] Found {len(ports)} open ports: {ports}")

    print("[*] Running vulnerability checks...")
    vulns = asyncio.run(run_checks(target_ip, ports))

    report = generate_report(target_ip, ports, vulns)
    with open("scan_report.json", "w") as f:
        json.dump(report, f, indent=4)
    print("[+] Report saved to scan_report.json")

