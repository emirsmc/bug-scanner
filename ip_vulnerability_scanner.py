import socket
import threading
import time
import re
import sys
from concurrent.futures import ThreadPoolExecutor, as_completed
import urllib.request
import urllib.error
from datetime import datetime

class OWASPVulnerabilityScanner:
    """
    Fast IP Vulnerability Scanner with OWASP Top 10 detection
    - A01:2021 Broken Access Control
    - A02:2021 Cryptographic Failures
    - A03:2021 Injection
    - A04:2021 Insecure Design
    - A05:2021 Security Misconfiguration
    - A06:2021 Vulnerable and Outdated Components
    - A07:2021 Identification and Authentication Failures
    - A08:2021 Software and Data Integrity Failures
    - A09:2021 Logging and Monitoring Failures
    - A10:2021 Server-Side Request Forgery
    """
    
    def __init__(self, target_ip, timeout=0.3, max_threads=500):
        self.target_ip = target_ip
        self.timeout = timeout
        self.max_threads = max_threads
        self.open_ports = []
        self.vulnerabilities = []
        self.service_banners = {}
        
    def fast_port_scan(self, start_port=1, end_port=65535):
        """Ultra-fast multi-threaded port scanning"""
        print(f"\n[*] Starting ultra-fast port scan on {self.target_ip}")
        print(f"[*] Scanning ports {start_port}-{end_port} with {self.max_threads} threads...")
        start_time = time.time()
        
        with ThreadPoolExecutor(max_workers=self.max_threads) as executor:
            futures = {
                executor.submit(self._check_port, port): port 
                for port in range(start_port, end_port + 1)
            }
            
            for future in as_completed(futures):
                port = futures[future]
                try:
                    if future.result():
                        self.open_ports.append(port)
                        print(f"[+] Port {port} OPEN")
                except Exception:
                    pass
        
        elapsed = time.time() - start_time
        print(f"[*] Scan completed in {elapsed:.2f} seconds")
        print(f"[+] Found {len(self.open_ports)} open ports: {sorted(self.open_ports)}")
        return sorted(self.open_ports)
    
    def _check_port(self, port):
        """Check if a single port is open"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(self.timeout)
            result = sock.connect_ex((self.target_ip, port))
            sock.close()
            return result == 0
        except Exception:
            return False
    
    def get_service_banner(self, port):
        """Attempt to grab service banner for version detection"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            sock.connect((self.target_ip, port))
            banner = sock.recv(1024).decode('utf-8', errors='ignore').strip()
            sock.close()
            return banner
        except Exception:
            return None
    
    def scan_owasp_vulnerabilities(self):
        """Comprehensive OWASP Top 10 vulnerability scanning"""
        print(f"\n[*] Scanning for OWASP Top 10 vulnerabilities...")
        
        for port in self.open_ports[:20]:  # Check first 20 open ports
            self._scan_port_vulnerabilities(port)
        
        return self.vulnerabilities
    
    def _scan_port_vulnerabilities(self, port):
        """Scan individual port for vulnerabilities"""        
        # A01: Broken Access Control - Check for admin panels
        if port in [80, 8080, 8000, 3000]:
            self._check_broken_access_control(port)
        
        # A02: Cryptographic Failures - Check for SSL/TLS issues
        if port == 443 or port in [8443, 465]:
            self._check_cryptographic_failures(port)
        
        # A03: Injection - Check for SQL/Command injection
        if port in [3306, 5432, 27017]:  # Database ports
            self._check_injection_vulnerabilities(port)
        
        # A05: Security Misconfiguration - Check common misconfigurations
        self._check_security_misconfiguration(port)
        
        # A07: Authentication Failures - Check weak auth
        self._check_auth_failures(port)
    
    def _check_broken_access_control(self, port):
        """A01: Check for broken access control"""
        try:
            url = f"http://{self.target_ip}:{port}"
            req = urllib.request.Request(url, timeout=2)
            response = urllib.request.urlopen(req)
            headers = dict(response.headers)
            
            # Check for missing CORS headers
            if 'Access-Control-Allow-Origin' not in headers:
                vuln = {
                    'type': 'A01 - Broken Access Control',
                    'port': port,
                    'issue': 'Missing CORS headers - potential unauthorized access',
                    'severity': 'HIGH',
                    'timestamp': datetime.now().isoformat()
                }
                self.vulnerabilities.append(vuln)
                print(f"[!] {vuln['type']} on port {port}")
        except Exception:
            pass
    
    def _check_cryptographic_failures(self, port):
        """A02: Check for cryptographic failures"""
        try:
            # Check for SSL/TLS versions
            banner = self.get_service_banner(port)
            if banner:
                self.service_banners[port] = banner
                
                # Check for insecure protocols
                if any(x in banner.lower() for x in ['ssl', 'tls 1.0', 'tls 1.1']):
                    vuln = {
                        'type': 'A02 - Cryptographic Failures',
                        'port': port,
                        'issue': 'Insecure SSL/TLS version detected',
                        'severity': 'CRITICAL',
                        'banner': banner,
                        'timestamp': datetime.now().isoformat()
                    }
                    self.vulnerabilities.append(vuln)
                    print(f"[!] {vuln['type']} on port {port}")
        except Exception:
            pass
    
    def _check_injection_vulnerabilities(self, port):
        """A03: Check for injection vulnerabilities"""
        common_payloads = ["' OR '1'='1", "1; DROP TABLE--", "admin'--"]
        vuln_found = False
        
        for payload in common_payloads:
            try:
                url = f"http://{self.target_ip}:{port}/?id={payload}"
                req = urllib.request.Request(url, timeout=2)
                response = urllib.request.urlopen(req)
                if response.status == 200:
                    vuln_found = True
                    break
            except Exception:
                pass
        
        if vuln_found:
            vuln = {
                'type': 'A03 - Injection',
                'port': port,
                'issue': 'Potential SQL/Command injection vulnerability detected',
                'severity': 'CRITICAL',
                'timestamp': datetime.now().isoformat()
            }
            self.vulnerabilities.append(vuln)
            print(f"[!] {vuln['type']} on port {port}")
    
    def _check_security_misconfiguration(self, port):
        """A05: Check for security misconfiguration"""
        try:
            url = f"http://{self.target_ip}:{port}"
            req = urllib.request.Request(url, timeout=2)
            response = urllib.request.urlopen(req)
            headers = dict(response.headers)
            
            issues = []
            
            # Check for missing security headers
            security_headers = [
                'X-Frame-Options',
                'X-Content-Type-Options',
                'Content-Security-Policy',
                'Strict-Transport-Security'
            ]
            
            missing_headers = [h for h in security_headers if h not in headers]
            
            if missing_headers:
                vuln = {
                    'type': 'A05 - Security Misconfiguration',
                    'port': port,
                    'issue': f'Missing security headers: {", ".join(missing_headers)}',
                    'severity': 'MEDIUM',
                    'timestamp': datetime.now().isoformat()
                }
                self.vulnerabilities.append(vuln)
                print(f"[!] {vuln['type']} on port {port}")
            
            # Check for directory listing
            if 'Index of' in response.read().decode('utf-8', errors='ignore'):
                vuln = {
                    'type': 'A05 - Security Misconfiguration',
                    'port': port,
                    'issue': 'Directory listing enabled',
                    'severity': 'HIGH',
                    'timestamp': datetime.now().isoformat()
                }
                self.vulnerabilities.append(vuln)
                print(f"[!] Directory listing on port {port}")
        except Exception:
            pass
    
    def _check_auth_failures(self, port):
        """A07: Check for authentication failures"""
        default_credentials = [
            ('admin', 'admin'),
            ('admin', 'password'),
            ('root', 'root'),
            ('test', 'test')
        ]
        
        for username, password in default_credentials:
            # This is a placeholder - actual implementation would depend on auth type
            pass
    
    def generate_report(self):
        """Generate comprehensive vulnerability report"""
        print("\n" + "="*70)
        print("VULNERABILITY SCAN REPORT")
        print("="*70)
        print(f"Target IP: {self.target_ip}")
        print(f"Scan Time: {datetime.now().isoformat()}")
        print(f"Open Ports Found: {len(self.open_ports)}")
        print(f"Vulnerabilities Found: {len(self.vulnerabilities)}")
        print("="*70)
        
        if self.vulnerabilities:
            print("\nVULNERABILITIES DISCOVERED:\n")
            for i, vuln in enumerate(self.vulnerabilities, 1):
                print(f"{i}. {vuln['type']}")
                print(f"   Port: {vuln['port']}")
                print(f"   Issue: {vuln['issue']}")
                print(f"   Severity: {vuln['severity']}")
                print(f"   Time: {vuln['timestamp']}")
                print()  
        else:
            print("\n[+] No OWASP vulnerabilities detected!")
        
        print("="*70)
        return self.vulnerabilities

def main():
    """Main execution function"""
    print("""
    ╔═══════════════════════════════════════════════════════════════╗
    ║       OWASP TOP 10 VULNERABILITY SCANNER - FAST VERSION       ║
    ║                    Security Assessment Tool                   ║
    ╚═══════════════════════════════════════════════════════════════╝
    """)
    
    try:
        target_ip = input("Enter target IP address: ").strip()
        
        # Validate IP format
        if not all(part.isdigit() and 0 <= int(part) <= 255 for part in target_ip.split('.')):
            print("[-] Invalid IP address format!")
            return
        
        scanner = OWASPVulnerabilityScanner(target_ip, timeout=0.3, max_threads=500)
        
        # Run fast port scan
        open_ports = scanner.fast_port_scan(1, 65535)
        
        if open_ports:
            # Scan for vulnerabilities
            vulnerabilities = scanner.scan_owasp_vulnerabilities()
            
            # Generate report
            scanner.generate_report()
        else:
            print("[-] No open ports found")
    
    except KeyboardInterrupt:
        print("\n[-] Scan interrupted by user")
        sys.exit(0)
    except Exception as e:
        print(f"[-] Error: {str(e)}")

if __name__ == '__main__':
    main()