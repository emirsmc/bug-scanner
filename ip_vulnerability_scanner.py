import socket
import concurrent.futures
import requests
import json
from datetime import datetime

# -------------------------------
# CONFIG
# -------------------------------
THREADS = 500
PORT_RANGE = range(1, 65536)
OWASP_CHECKS = ["sql_injection", "xss", "headers"]

# -------------------------------
# PORT SCANNER
# -------------------------------
def scan_port(ip, port):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(0.5)
        result = sock.connect_ex((ip, port))
        sock.close()
        if result == 0:
            return port
    except:
        return None

def fast_port_scan(ip):
    open_ports = []
    with concurrent.futures.ThreadPoolExecutor(max_workers=THREADS) as executor:
        futures = [executor.submit(scan_port, ip, port) for port in PORT_RANGE]
        for f in concurrent.futures.as_completed(futures):
            port = f.result()
            if port:
                open_ports.append(port)
    return open_ports

# -------------------------------
# OWASP CHECKS
# -------------------------------
def check_sql_injection(url):
    payload = "' OR '1'='1"
    try:
        r = requests.get(url, params={"id": payload}, timeout=3)
        if "syntax" in r.text.lower() or "error" in r.text.lower():
            return {"vuln": "SQL Injection", "severity": "High", "reference": "OWASP A1"}
    except:
        pass
    return None

def check_xss(url):
    payload = "<script>alert(1)</script>"
    try:
        r = requests.get(url, params={"q": payload}, timeout=3)
        if payload in r.text:
            return {"vuln": "Cross-Site Scripting (XSS)", "severity": "High", "reference": "OWASP A3"}
    except:
        pass
    return None

def check_headers(url):
    try:
        r = requests.get(url, timeout=3)
        headers = r.headers
        missing = []
        if "Content-Security-Policy" not in headers:
            missing.append("CSP")
        if "Strict-Transport-Security" not in headers:
            missing.append("HSTS")
        if missing:
            return {"vuln": f"Insecure Headers: {', '.join(missing)}", "severity": "Medium", "reference": "OWASP A6"}
    except:
        pass
    return None

def run_owasp_checks(ip, ports):
    vulns = []
    for port in ports:
        if port in [80, 443]:
            url = f"http://{ip}" if port == 80 else f"https://{ip}"
            for check in [check_sql_injection, check_xss, check_headers]:
                result = check(url)
                if result:
                    vulns.append(result)
    return vulns

# -------------------------------
# REPORTING
# -------------------------------
def generate_report(ip, ports, vulns):
    report = {
        "target": ip,
        "scan_time": datetime.now().isoformat(),
        "open_ports": ports,
        "vulnerabilities": vulns
    }
    print("\n================= SCAN REPORT =================")
    print(json.dumps(report, indent=4))
    return report

# -------------------------------
# MAIN
# -------------------------------
if __name__ == "__main__":
    target_ip = input("Enter target IP address: ")
    print(f"[*] Starting ultra-fast port scan on {target_ip}")
    ports = fast_port_scan(target_ip)
    print(f"[+] Found {len(ports)} open ports: {ports}")

    print("[*] Running OWASP Top 10 checks...")
    vulns = run_owasp_checks(target_ip, ports)

    report = generate_report(target_ip, ports, vulns)
    with open("scan_report.json", "w") as f:
        json.dump(report, f, indent=4)
    print("[+] Report saved to scan_report.json")
