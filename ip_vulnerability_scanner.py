import socket, asyncio, aiohttp, json
from datetime import datetime

# -------------------------------
# Ethical Notice
# -------------------------------
def ethical_notice():
    print("""
╔══════════════════════════════════════════════════════════════╗
║   ETHICAL NOTICE: This tool is for authorized use only.       ║
║   Run scans only with explicit permission.                    ║
║   Unauthorized use is illegal and unethical.                  ║
╚══════════════════════════════════════════════════════════════╝
    """)

# -------------------------------
# Severity Scoring + Colors
# -------------------------------
SEVERITY_SCORES = {
    "Critical": 9.0,
    "High": 7.0,
    "Medium": 5.0,
    "Low": 3.0,
    "Info": 1.0
}
SEVERITY_COLORS = {
    "Critical": "red",
    "High": "darkred",
    "Medium": "orange",
    "Low": "blue",
    "Info": "gray"
}

# -------------------------------
# Async Port Scanner (fast mode)
# -------------------------------
COMMON_PORTS = [21,22,23,25,53,80,110,143,443,445,3389,8080,8443]  # extendable

async def async_scan_port(ip, port):
    try:
        conn = asyncio.open_connection(ip, port)
        reader, writer = await asyncio.wait_for(conn, timeout=0.2)
        writer.close()
        await writer.wait_closed()
        return port
    except:
        return None

async def fast_port_scan(ip, ports=COMMON_PORTS):
    tasks = [async_scan_port(ip, p) for p in ports]
    results = await asyncio.gather(*tasks)
    return [p for p in results if p]

# -------------------------------
# OWASP Checks (examples shown)
# -------------------------------
async def check_injection(session, url):
    payloads = ["' OR '1'='1", "admin'--", "1; DROP TABLE users"]
    for p in payloads:
        try:
            async with session.get(url, params={"id": p}) as r:
                text = await r.text()
                if "error" in text.lower() or "syntax" in text.lower():
                    return {
                        "vuln": "Injection",
                        "severity": "High",
                        "score": SEVERITY_SCORES["High"],
                        "reference": "OWASP A1",
                        "payload": p,
                        "response_snippet": text[:200]
                    }
        except:
            pass
    return None

async def check_xss(session, url):
    payloads = ["<script>alert(1)</script>", "\" onmouseover=alert(1) x=\""]
    for p in payloads:
        try:
            async with session.get(url, params={"q": p}) as r:
                text = await r.text()
                if p in text:
                    return {
                        "vuln": "Cross-Site Scripting (XSS)",
                        "severity": "High",
                        "score": SEVERITY_SCORES["High"],
                        "reference": "OWASP A7",
                        "payload": p,
                        "response_snippet": text[:200]
                    }
        except:
            pass
    return None

async def check_headers(session, url):
    try:
        async with session.get(url) as r:
            headers = r.headers
            missing = []
            if "Content-Security-Policy" not in headers:
                missing.append("CSP")
            if "Strict-Transport-Security" not in headers:
                missing.append("HSTS")
            if missing:
                return {
                    "vuln": f"Insecure Headers: {', '.join(missing)}",
                    "severity": "Medium",
                    "score": SEVERITY_SCORES["Medium"],
                    "reference": "OWASP A6",
                    "payload": None,
                    "response_snippet": str(dict(headers))[:200]
                }
    except:
        pass
    return None

# -------------------------------
# Run All Checks
# -------------------------------
async def run_checks(ip, ports):
    vulns = []
    async with aiohttp.ClientSession() as session:
        tasks = []
        for port in ports:
            if port in [80, 443]:
                url = f"http://{ip}" if port == 80 else f"https://{ip}"
                tasks.extend([
                    check_injection(session, url),
                    check_xss(session, url),
                    check_headers(session, url)
                ])
        results = await asyncio.gather(*tasks)
        for r in results:
            if r:
                vulns.append(r)
                with open("responses.log", "a") as log:
                    log.write(json.dumps(r, indent=4) + "\n")
    return vulns

# -------------------------------
# Reporting
# -------------------------------
def generate_report(ip, ports, vulns):
    report = {
        "target": ip,
        "scan_time": datetime.now().isoformat(),
        "open_ports": ports,
        "vulnerabilities": vulns
    }
    print("\n================= SCAN REPORT =================")
    print(json.dumps(report, indent=4))
    return report

def generate_html_report(report):
    html = f"""
<html>
<head>
<title>Bug Scanner Report</title>
<style>
body {{ font-family: Arial; background: #f4f4f4; }}
h1 {{ color: #333; }}
table {{ border-collapse: collapse; width: 100%; }}
th, td {{ border: 1px solid #ccc; padding: 8px; }}
th {{ background: #eee; }}
</style>
</head>
<body>
<h1>Bug Scanner Report</h1>
<p><b>Target:</b> {report['target']}</p>
<p><b>Scan Time:</b> {report['scan_time']}</p>
<p><b>Open Ports:</b> {report['open_ports']}</p>
<h2>Vulnerabilities</h2>
<table>
<tr><th>Vulnerability</th><th>Severity</th><th>Score</th><th>Reference</th><th>Payload</th><th>Response Snippet</th></tr>
"""
    for v in report["vulnerabilities"]:
        color = SEVERITY_COLORS.get(v["severity"], "black")
        html += f"<tr><td>{v['vuln']}</td><td style='color:{color}'>{v['severity']}</td><td>{v['score']}</td><td>{v['reference']}</td><td>{v['payload']}</td><td>{v['response_snippet']}</td></tr>"
    html += "</table></body></html>"
    with open("scan_report.html", "w") as f:
        f.write(html)
    print("[+] HTML report saved to scan_report.html")

# -------------------------------
# Main
# -------------------------------
if __name__ == "__main__":
    ethical_notice()
    target_ip = input("Enter target IP address: ")
    confirm = input("Type 'YES' to confirm you have permission to scan: ")
    if confirm != "YES":
        print("[!] Scan aborted. Permission not confirmed.")
        exit()

    print(f"[*] Starting ultra-fast port scan on {target_ip}")
    ports = asyncio.run(fast_port_scan(target_ip))
    print(f"[+] Found {len(ports)} open ports: {ports}")

    print("[*] Running OWASP Top 10 checks...")
    vulns = asyncio.run(run_checks(target_ip, ports))

    report = generate_report(target_ip, ports, vulns)
    with open("scan_report.json", "w") as f:
        json.dump(report, f, indent=4)
    print("[+] JSON report saved to scan_report.json")

    generate_html_report(report)
