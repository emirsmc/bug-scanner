# -------------------------------
# OWASP A2: Broken Authentication
# -------------------------------
async def check_auth(session, url):
    try:
        async with session.get(url + "/login") as r:
            text = await r.text()
            if "password" in text.lower() and "login" in text.lower():
                return {
                    "vuln": "Broken Authentication",
                    "severity": "Medium",
                    "score": SEVERITY_SCORES["Medium"],
                    "reference": "OWASP A2",
                    "payload": None,
                    "evidence": {
                        "request": url + "/login",
                        "response_code": r.status,
                        "response_snippet": text[:200]
                    },
                    "remediation": "Implement multi-factor authentication, secure password storage, and rate limiting."
                }
    except:
        pass
    return None

# -------------------------------
# OWASP A3: Sensitive Data Exposure
# -------------------------------
async def check_sensitive_data(session, url):
    try:
        async with session.get(url) as r:
            if not url.startswith("https://"):
                return {
                    "vuln": "Sensitive Data Exposure",
                    "severity": "High",
                    "score": SEVERITY_SCORES["High"],
                    "reference": "OWASP A3",
                    "payload": None,
                    "evidence": {
                        "request": url,
                        "response_code": r.status,
                        "response_snippet": str(r.headers)[:200]
                    },
                    "remediation": "Use HTTPS/TLS with strong ciphers and avoid transmitting sensitive data in plaintext."
                }
    except:
        pass
    return None

# -------------------------------
# OWASP A4: XML External Entities (XXE)
# -------------------------------
async def check_xxe(session, url):
    payload = """<?xml version="1.0"?>
    <!DOCTYPE foo [ <!ELEMENT foo ANY >
    <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
    <foo>&xxe;</foo>"""
    try:
        async with session.post(url, data=payload, headers={"Content-Type":"application/xml"}) as r:
            text = await r.text()
            if "root:" in text or "passwd" in text:
                return {
                    "vuln": "XML External Entities (XXE)",
                    "severity": "High",
                    "score": SEVERITY_SCORES["High"],
                    "reference": "OWASP A4",
                    "payload": payload,
                    "evidence": {
                        "request": url,
                        "response_code": r.status,
                        "response_snippet": text[:200]
                    },
                    "remediation": "Disable external entity processing in XML parsers and use secure libraries."
                }
    except:
        pass
    return None

# -------------------------------
# OWASP A5: Broken Access Control
# -------------------------------
async def check_access_control(session, url):
    test_urls = [url + "/admin", url + "/user/1", url + "/user/2"]
    for t in test_urls:
        try:
            async with session.get(t) as r:
                text = await r.text()
                if "unauthorized" not in text.lower() and r.status == 200:
                    return {
                        "vuln": "Broken Access Control",
                        "severity": "High",
                        "score": SEVERITY_SCORES["High"],
                        "reference": "OWASP A5",
                        "payload": None,
                        "evidence": {
                            "request": t,
                            "response_code": r.status,
                            "response_snippet": text[:200]
                        },
                        "remediation": "Enforce proper authorization checks on every request."
                    }
        except:
            pass
    return None

# -------------------------------
# OWASP A8: Insecure Deserialization
# -------------------------------
async def check_deserialization(session, url):
    payload = '{"user":"admin","role":"admin"}'
    try:
        async with session.post(url, data=payload, headers={"Content-Type":"application/json"}) as r:
            text = await r.text()
            if "admin" in text.lower() and "role" in text.lower():
                return {
                    "vuln": "Insecure Deserialization",
                    "severity": "High",
                    "score": SEVERITY_SCORES["High"],
                    "reference": "OWASP A8",
                    "payload": payload,
                    "evidence": {
                        "request": url,
                        "response_code": r.status,
                        "response_snippet": text[:200]
                    },
                    "remediation": "Avoid deserializing untrusted data. Use safe serialization formats."
                }
    except:
        pass
    return None

# -------------------------------
# OWASP A9: Using Components with Known Vulnerabilities
# -------------------------------
async def check_components(session, url):
    try:
        async with session.get(url) as r:
            server = r.headers.get("Server", "")
            if "apache/2.2" in server.lower() or "php/5" in server.lower():
                return {
                    "vuln": "Outdated Components",
                    "severity": "Medium",
                    "score": SEVERITY_SCORES["Medium"],
                    "reference": "OWASP A9",
                    "payload": None,
                    "evidence": {
                        "request": url,
                        "response_code": r.status,
                        "response_snippet": server
                    },
                    "remediation": "Update server software and frameworks to patched versions."
                }
    except:
        pass
    return None

# -------------------------------
# OWASP A10: Insufficient Logging & Monitoring
# -------------------------------
async def check_logging(session, url):
    try:
        async with session.get(url + "/invalidpage") as r:
            text = await r.text()
            if "error" not in text.lower() and r.status == 200:
                return {
                    "vuln": "Insufficient Logging & Monitoring",
                    "severity": "Low",
                    "score": SEVERITY_SCORES["Low"],
                    "reference": "OWASP A10",
                    "payload": None,
                    "evidence": {
                        "request": url + "/invalidpage",
                        "response_code": r.status,
                        "response_snippet": text[:200]
                    },
                    "remediation": "Implement proper error handling, logging, and monitoring of suspicious activity."
                }
    except:
        pass
    return None
